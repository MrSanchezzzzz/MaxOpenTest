import 'package:flutter/material.dart';
import 'package:maxopentest/screens/detail_screen.dart';
import 'package:maxopentest/utils/colors.dart';
import 'package:maxopentest/utils/double.dart';
import 'package:maxopentest/widgets/movie_poster.dart';
import 'package:maxopentest/widgets/rating_indicator.dart';

import '../entities/movie.dart';
import '../utils/shared_preferences.dart';

class MovieCard extends StatefulWidget {
  const MovieCard({super.key,this.movie,this.showBookmark=true});
  final Movie? movie;
  final bool showBookmark;

  @override
  State<MovieCard> createState() => _MovieCardState();
}

class _MovieCardState extends State<MovieCard> {
  Future<void> toggleFavorite() async {
    if(widget.movie==null){
      return;
    }
    if(_isFavorite){
      Preferences.removeFromFavorites(movie: widget.movie!);
      _isFavorite=false;
    }
    else{
      Preferences.addToFavorites(movie: widget.movie!);
      _isFavorite=true;
    }
    setState(() {
    });
  }

  bool _isFavorite=false;
  void checkIfFavorite() async {
    if (widget.movie != null) {
      _isFavorite = await Preferences.isFavorite(movie: widget.movie!);
    }
  }

  @override
  Widget build(BuildContext context) {
    checkIfFavorite();
    const double scale = 1;
    final width = (MediaQuery.of(context).size.width / 2.75) * scale;
    final height = (MediaQuery.of(context).size.width / 2) * scale;
    return Container(
      margin: EdgeInsets.symmetric(vertical: 8),
      height: height,
      child: InkWell(
        onTap: (){Navigator.of(context).push(MaterialPageRoute(builder: (context)=>DetailScreen(movie: widget.movie!,)));},
        child: Row(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            MoviePoster(width: width, height: height,url: widget.movie?.posterUrl,showBookmark: widget.showBookmark,isFavorite: _isFavorite,onTap: toggleFavorite,),
            Expanded(
              child: Padding(
                padding: EdgeInsets.symmetric(horizontal: 16),
                child: Column(
                  mainAxisAlignment: MainAxisAlignment.start,
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Text(
                      widget.movie?.title??'',
                      style: TextStyle(
                        fontSize: 20,
                        fontFamily: 'Poppins',
                        fontWeight: FontWeight.w700,
                      ),
                      overflow: TextOverflow.ellipsis,
                      softWrap: true,
                      maxLines: 2,
                    ),
                    const SizedBox(height: 10,),
                    RatingIndicator(rating: widget.movie?.rating??0),
                    const SizedBox(height: 10,),
                    Text(widget.movie!.genres.join(','),style: TextStyle(fontSize: 14,fontFamily: 'Poppins'),),
                    const SizedBox(height: 10,),
                    Text(
                      widget.movie!.overview,
                      style: TextStyle(
                        fontSize: 13,
                        fontFamily: 'Poppins',
                        color: HexColor.fromHex('#888888'),
                      ),
                      overflow: TextOverflow.ellipsis,
                      maxLines: 3,
                      softWrap: true,
                    ),
                  ],
                ),
              ),
            ),
          ],
        ),
      ),
    );

  }
}
